# Nova Sonic 多设备管理系统需求文档

## 1. 项目概述

基于现有的 Nova Sonic S2S 项目，已成功实现一个支持多设备接入的语音交互管理系统。系统包含增强的 Python 后端服务器 (enhanced_server.py)、支持多客户端设备接入、React 管理界面和 PostgreSQL 数据库存储。

## 2. 已实现功能

### 2.1 Python 服务器 (enhanced_server.py) - 已实现
- **核心功能**：完全支持后端与 Amazon Bedrock Nova Sonic 的接入
- **多设备支持**：同时支持多个硬件设备或其他客户端的并发连接
- **WebSocket 通信**：独立的 WebSocket 服务器 (端口8081) 进行实时通信
- **HTTP API**：独立的 HTTP 服务器 (端口8080) 提供管理接口
- **会话管理**：为每个设备维护独立的 S2S 会话状态
- **身份验证**：完整的 JWT 认证系统，支持用户名密码登录
- **数据库集成**：PostgreSQL 数据库存储设备配置和用户信息
- **保留现有接口**：完全兼容原有 websocket 接口和 S2S 接入逻辑

### 2.2 多客户端支持 - 已实现
- **硬件客户端**：完整的 Python 硬件客户端实现 (device_client.py)
- **多平台兼容**：支持基于不同技术栈的客户端接入
- **语音处理**：客户端完整支持语音输入采集和 Nova Sonic 回复播放
- **完整响应处理**：支持接收所有 Nova Sonic 响应（音频输出、文本输出、工具使用结果等）
- **WebSocket 通信**：通过 WebSocket 与服务器进行双向通信
- **双重认证机制**：支持新的 JWT 认证和向后兼容的设备注册模式

### 2.3 React 管理端 (react-management) - 已实现
- **设备管理**：完整的设备列表显示、在线状态监控、设备操作（重启会话等）
- **配置管理**：设备级别的个性化配置界面，支持实时配置更新
- **实时监控**：设备连接状态、会话信息、使用统计的实时监控
- **Token 指标**：完整的 token 消耗统计和使用情况展示
- **认证系统**：完整的登录界面和 JWT 认证机制
- **事件日志**：实时的 S2S 事件显示和日志记录


### 2.4 React 管理端配置功能 - 已实现
- **系统提示词配置**：设备级别的个性化系统提示词设置
- **动态 MCP 工具接入**：完整的 MCP 服务器管理和配置系统
- **Bedrock Knowledge Base**：知识库 ID 配置和 RAG 参数设置
- **Bedrock Agents**：Lambda ARN 配置和智能代理集成
- **Strands Agent**：天气查询和位置服务代理配置
- **语音角色配置**：11种语音角色选择（英语、法语、意大利语、德语、西班牙语）
- **模型参数配置**：Max Tokens、Temperature、Top P 等参数调节
- **聊天历史管理**：设备级别的对话历史记录存储和恢复

### 2.5 用户认证系统 - 已实现
- **JWT 认证**：完整的 JWT token 认证系统
- **用户管理**：PostgreSQL 数据库存储用户信息
- **会话管理**：token 过期管理和会话状态维护
- **角色权限**：管理员和设备用户角色区分
- **默认账户**：预设管理员账户 (admin/admin123) 和设备账户 (device/device123)
- **密码安全**：SHA256 密码哈希存储

## 3. 已达成的非功能需求

### 3.1 性能要求 - 已实现
- ✅ 支持最多 50 个设备同时在线（可配置 MAX_CONCURRENT_DEVICES）
- ✅ WebSocket 连接快速响应
- ✅ 异步处理确保低延迟语音处理
- ✅ 数据库连接池优化（5-20个连接）

### 3.2 可靠性要求 - 已实现
- ✅ 设备断线自动清理和重连支持
- ✅ PostgreSQL 数据库持久化存储
- ✅ 会话状态管理和恢复
- ✅ 错误处理和日志记录

### 3.3 安全要求 - 已实现
- ✅ JWT token 认证和授权
- ✅ 密码哈希存储（SHA256）
- ✅ CORS 跨域保护
- ✅ API 接口访问控制

### 3.4 可扩展性要求 - 已实现
- ✅ 模块化架构设计
- ✅ 动态 MCP 服务器管理
- ✅ 插件式工具集成
- ✅ 数据库驱动的配置管理

## 4. 用户角色 - 已实现

### 4.1 设备用户 (device_user)
- ✅ 通过硬件客户端进行语音交互
- ✅ JWT 认证登录机制
- ✅ 接收设备级别个性化的 AI 回复
- ✅ 支持多种工具集成（MCP、Knowledge Base、Agents等）

### 4.2 管理员 (admin)
- ✅ 通过 React 管理界面配置系统
- ✅ 完整的设备管理功能
- ✅ 实时系统监控和统计
- ✅ MCP 服务器管理
- ✅ 设备配置管理

## 5. 使用场景 - 已实现

### 5.1 设备接入场景 - 完整实现
1. ✅ 设备启动并连接到 WebSocket 服务器
2. ✅ JWT 认证或向后兼容的设备注册
3. ✅ 自动获取设备个性化配置
4. ✅ 建立 S2S 会话并开始语音交互
5. ✅ 实时接收和处理 Nova Sonic 响应

### 5.2 配置管理场景 - 完整实现
1. ✅ 管理员通过 React 界面登录
2. ✅ 查看设备列表和状态
3. ✅ 选择设备并打开配置界面
4. ✅ 修改语音、提示词、工具等配置
5. ✅ 实时保存并应用配置（自动重启会话）

### 5.3 设备监控场景 - 完整实现
1. ✅ 实时查看在线设备列表
2. ✅ 监控设备连接状态和最后活跃时间
3. ✅ 手动重启设备会话
4. ✅ 查看设备使用统计和事件日志

## 6. 技术实现约束 - 已遵循

### 6.1 技术约束 - 完全遵循
- ✅ 基于现有 Nova Sonic S2S 项目架构扩展
- ✅ 保持原有 websocket 接口和 S2S 接入逻辑不变
- ✅ 使用 Python 3.12+ 和现代 Node.js
- ✅ 完全依赖 AWS Bedrock Nova Sonic 服务
- ✅ PostgreSQL 数据库存储

### 6.2 业务约束 - 完全满足
- ✅ 100% 向后兼容现有功能
- ✅ 支持所有现有集成模式（MCP、Strands、Knowledge Base、Agents）
- ✅ 配置变更实时生效（自动会话重启）
- ✅ 保持原有客户端接入方式

## 7. 新增功能特性

### 7.1 动态 MCP 管理
- ✅ 数据库驱动的 MCP 服务器配置
- ✅ 设备级别的 MCP 服务器选择
- ✅ 运行时动态加载 MCP 服务器
- ✅ 完整的 MCP 服务器管理界面

### 7.2 增强的工具集成
- ✅ Universal MCP Manager 统一管理
- ✅ 设备配置驱动的工具加载
- ✅ 多种工具类型支持（MCP、KB、Agents、Strands）
- ✅ 工具配置的实时应用

### 7.3 完整的数据持久化
- ✅ 用户和设备信息存储
- ✅ 设备配置持久化
- ✅ 会话历史记录
- ✅ MCP 服务器配置存储

### 7.4 生产级部署支持
- ✅ 环境变量配置管理
- ✅ 数据库连接池
- ✅ 健康检查端点
- ✅ 日志和监控
- ✅ 容器化部署支持

### 7.5 安全增强
- ✅ JWT 认证系统
- ✅ 密码哈希存储
- ✅ CORS 跨域保护
- ✅ API 访问控制
- ✅ 会话管理和过期处理

### 7.6 监控和统计
- ✅ 实时设备状态监控
- ✅ Token 使用统计
- ✅ 会话数据记录
- ✅ 事件日志显示
- ✅ 性能指标监控

### 7.7 用户管理功能 - 新增
- ✅ 设备端用户注册功能
- ✅ 设备端密码修改功能
- ✅ 管理端用户管理界面
- ✅ 管理端用户创建和密码修改
- ✅ bcrypt密码哈希升级
- ✅ 向后兼容现有用户
- ✅ 用户角色权限管理
- ✅ 用户活动监控

## 8. 用户管理详细说明

系统现在支持完整的用户管理功能，包括设备端和管理端的用户操作。详细功能说明请参考：[用户管理文档](user-management.md)

### 8.1 默认用户保留
- 管理员用户：admin / admin123
- 设备用户：device / device123
- 所有现有功能完全兼容

### 8.2 新增功能
- 设备端WebSocket用户注册和密码修改
- 管理端React界面用户管理
- 安全的bcrypt密码哈希
- 完整的权限控制系统